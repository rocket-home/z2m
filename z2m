#!/usr/bin/env bash
#
# Z2M Manager Launcher
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
#

set -e

# Resolve symlink so script can be installed as /usr/local/bin/z2m -> <repo>/z2m
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
  LINK="$(readlink "$SOURCE")"
  if [[ "$LINK" != /* ]]; then
    SOURCE="$DIR/$LINK"
  else
    SOURCE="$LINK"
  fi
done
SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
VENV_DIR="$SCRIPT_DIR/.venv"
UV_DIR="$SCRIPT_DIR/.uv"
MARKER_FILE="$SCRIPT_DIR/.deps_installed"
REQ_FILE="$SCRIPT_DIR/z2m_manager/requirements.txt"

# –¶–≤–µ—Ç–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info()    { echo -e "${BLUE}‚Ñπ${NC} $1"; }
log_success() { echo -e "${GREEN}‚úì${NC} $1"; }
log_warning() { echo -e "${YELLOW}‚ö†${NC} $1"; }
log_error()   { echo -e "${RED}‚úó${NC} $1"; }

PYTHON_CMD=""
UV_CMD=""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Python 3
check_python() {
    for cmd in python3 python; do
        if command -v "$cmd" &>/dev/null; then
            if $cmd --version 2>&1 | grep -q "Python 3"; then
                PYTHON_CMD="$cmd"
                break
            fi
        fi
    done

    if [ -z "$PYTHON_CMD" ]; then
        log_error "Python 3 –Ω–µ –Ω–∞–π–¥–µ–Ω"
        echo "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: sudo apt install python3"
        exit 1
    fi

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ >= 3.8
    local ver
    ver=$($PYTHON_CMD -c "import sys; v=sys.version_info; print(f'{v.major}{v.minor:02d}')")
    if [ "$ver" -lt 308 ]; then
        log_error "–¢—Ä–µ–±—É–µ—Ç—Å—è Python 3.8+, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω $($PYTHON_CMD --version)"
        exit 1
    fi
}

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ uv (–µ—Å–ª–∏ –Ω–µ—Ç pip –∏ venv)
install_uv() {
    mkdir -p "$UV_DIR"

    log_info "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ uv (–º–µ–Ω–µ–¥–∂–µ—Ä –ø–∞–∫–µ—Ç–æ–≤)..."

    # –°–∫–∞—á–∏–≤–∞–µ–º uv
    export UV_NO_MODIFY_PATH=1
    if command -v curl &>/dev/null; then
        curl -sSfL https://astral.sh/uv/install.sh | CARGO_HOME="$UV_DIR" UV_INSTALL_DIR="$UV_DIR/bin" sh 2>/dev/null
    elif command -v wget &>/dev/null; then
        wget -qO- https://astral.sh/uv/install.sh | CARGO_HOME="$UV_DIR" UV_INSTALL_DIR="$UV_DIR/bin" sh 2>/dev/null
    else
        log_error "–ù—É–∂–µ–Ω curl –∏–ª–∏ wget"
        exit 1
    fi

    if [ -f "$UV_DIR/bin/uv" ]; then
        UV_CMD="$UV_DIR/bin/uv"
        log_success "uv —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    else
        log_error "–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å uv"
        exit 1
    fi
}

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
setup_environment() {
    local req_hash=""
    if command -v sha256sum &>/dev/null; then
        req_hash="$(sha256sum "$REQ_FILE" | awk '{print $1}')"
    else
        # fallback: mtime-based
        req_hash="$(stat -c %Y "$REQ_FILE" 2>/dev/null || echo 0)"
    fi

    local marker_hash=""
    if [ -f "$MARKER_FILE" ]; then
        marker_hash="$(cat "$MARKER_FILE" 2>/dev/null || true)"
    fi

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π venv
    if [ -d "$VENV_DIR" ] && [ -f "$VENV_DIR/bin/activate" ]; then
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ –æ–Ω
        if "$VENV_DIR/bin/python" -c "import textual, yaml; import paho.mqtt.client; import serial" 2>/dev/null; then
            # –ï—Å–ª–∏ requirements –∏–∑–º–µ–Ω–∏–ª–∏—Å—å ‚Äî –æ–±–Ω–æ–≤–∏–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            if [ -n "$req_hash" ] && [ "$req_hash" != "$marker_hash" ]; then
                log_info "–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ requirements.txt, –æ–±–Ω–æ–≤–ª—è—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
                source "$VENV_DIR/bin/activate"
                if command -v pip &>/dev/null; then
                    pip install -q -r z2m_manager/requirements.txt || true
                else
                    # pip –º–æ–∂–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å (venv —Å–æ–∑–¥–∞–Ω —á–µ—Ä–µ–∑ uv) ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º uv
                    if command -v uv &>/dev/null; then
                        UV_CMD="uv"
                    elif [ -f "$UV_DIR/bin/uv" ]; then
                        UV_CMD="$UV_DIR/bin/uv"
                    else
                        install_uv
                    fi
                    $UV_CMD pip install -p "$VENV_DIR/bin/python" -r z2m_manager/requirements.txt -q || true
                fi
                echo "$req_hash" > "$MARKER_FILE"
            fi
            return 0
        fi
    fi

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π pip
    if $PYTHON_CMD -m pip --version &>/dev/null; then
        # –ü—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å venv —á–µ—Ä–µ–∑ pip
        if $PYTHON_CMD -m venv "$VENV_DIR" 2>/dev/null; then
            source "$VENV_DIR/bin/activate"
            pip install -q -r z2m_manager/requirements.txt
            log_success "–û–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ (venv + pip)"
            echo "$req_hash" > "$MARKER_FILE"
            return 0
        fi
    fi

    # –ü—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π uv
    if command -v uv &>/dev/null; then
        UV_CMD="uv"
    elif [ -f "$UV_DIR/bin/uv" ]; then
        UV_CMD="$UV_DIR/bin/uv"
    else
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º uv
        install_uv
    fi

    # –°–æ–∑–¥–∞—ë–º venv —á–µ—Ä–µ–∑ uv
    log_info "–°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
    rm -rf "$VENV_DIR" 2>/dev/null || true

    $UV_CMD venv "$VENV_DIR" -p "$PYTHON_CMD" -q

    log_info "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
    $UV_CMD pip install -p "$VENV_DIR/bin/python" -r z2m_manager/requirements.txt -q

    log_success "–û–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ"
    echo "$req_hash" > "$MARKER_FILE"
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Docker
check_docker() {
    if ! command -v docker &>/dev/null; then
        log_warning "Docker –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        echo ""
        echo "–î–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Docker:"
        echo "  curl -fsSL https://get.docker.com | sh"
        echo "  sudo usermod -aG docker \$USER"
        echo ""
    fi
}

# –ó–∞–ø—É—Å–∫
run_app() {
    cd "$SCRIPT_DIR"
    source "$VENV_DIR/bin/activate"
    # —á—Ç–æ–±—ã –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (TUI/CLI) –±—ã–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã —É—Ç–∏–ª–∏—Ç—ã, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ª–æ–∫–∞–ª—å–Ω–æ –≤ –ø—Ä–æ–µ–∫—Ç (.uv/bin/uv)
    if [ -d "$UV_DIR/bin" ]; then
        export PATH="$UV_DIR/bin:$PATH"
    fi
    exec python z2m.py "$@"
}

main() {
    cd "$SCRIPT_DIR"

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º --cli –¥–ª—è —Ç–∏—Ö–æ–≥–æ —Ä–µ–∂–∏–º–∞
    local quiet=false
    for arg in "$@"; do
        [ "$arg" == "--cli" ] && quiet=true && break
    done

    if [ "$quiet" = false ]; then
        echo ""
        echo -e "${BLUE}üêù Z2M Manager${NC}"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo ""
    fi

    check_python

    # –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
    if [ ! -f "$MARKER_FILE" ]; then
        check_docker
    fi

    setup_environment
    run_app "$@"
}

main "$@"
