#!/usr/bin/env bash
#
# Z2M Manager Launcher
# ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VENV_DIR="$SCRIPT_DIR/.venv"
UV_DIR="$SCRIPT_DIR/.uv"
MARKER_FILE="$SCRIPT_DIR/.deps_installed"

# Ğ¦Ğ²ĞµÑ‚Ğ°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info()    { echo -e "${BLUE}â„¹${NC} $1"; }
log_success() { echo -e "${GREEN}âœ“${NC} $1"; }
log_warning() { echo -e "${YELLOW}âš ${NC} $1"; }
log_error()   { echo -e "${RED}âœ—${NC} $1"; }

PYTHON_CMD=""
UV_CMD=""

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Python 3
check_python() {
    for cmd in python3 python; do
        if command -v "$cmd" &>/dev/null; then
            if $cmd --version 2>&1 | grep -q "Python 3"; then
                PYTHON_CMD="$cmd"
                break
            fi
        fi
    done

    if [ -z "$PYTHON_CMD" ]; then
        log_error "Python 3 Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½"
        echo "Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ: sudo apt install python3"
        exit 1
    fi

    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ²ĞµÑ€ÑĞ¸Ğ¸ >= 3.8
    local ver
    ver=$($PYTHON_CMD -c "import sys; v=sys.version_info; print(f'{v.major}{v.minor:02d}')")
    if [ "$ver" -lt 308 ]; then
        log_error "Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Python 3.8+, ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ $($PYTHON_CMD --version)"
        exit 1
    fi
}

# Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° uv (ĞµÑĞ»Ğ¸ Ğ½ĞµÑ‚ pip Ğ¸ venv)
install_uv() {
    mkdir -p "$UV_DIR"

    log_info "Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° uv (Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€ Ğ¿Ğ°ĞºĞµÑ‚Ğ¾Ğ²)..."

    # Ğ¡ĞºĞ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ uv
    export UV_NO_MODIFY_PATH=1
    if command -v curl &>/dev/null; then
        curl -sSfL https://astral.sh/uv/install.sh | CARGO_HOME="$UV_DIR" UV_INSTALL_DIR="$UV_DIR/bin" sh 2>/dev/null
    elif command -v wget &>/dev/null; then
        wget -qO- https://astral.sh/uv/install.sh | CARGO_HOME="$UV_DIR" UV_INSTALL_DIR="$UV_DIR/bin" sh 2>/dev/null
    else
        log_error "ĞÑƒĞ¶ĞµĞ½ curl Ğ¸Ğ»Ğ¸ wget"
        exit 1
    fi

    if [ -f "$UV_DIR/bin/uv" ]; then
        UV_CMD="$UV_DIR/bin/uv"
        log_success "uv ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½"
    else
        log_error "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ uv"
        exit 1
    fi
}

# ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
setup_environment() {
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ venv
    if [ -d "$VENV_DIR" ] && [ -f "$VENV_DIR/bin/activate" ]; then
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ»Ğ¸ Ğ¾Ğ½
        if "$VENV_DIR/bin/python" -c "import textual" 2>/dev/null; then
            return 0
        fi
    fi

    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğ¹ pip
    if $PYTHON_CMD -m pip --version &>/dev/null; then
        # ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ venv Ñ‡ĞµÑ€ĞµĞ· pip
        if $PYTHON_CMD -m venv "$VENV_DIR" 2>/dev/null; then
            source "$VENV_DIR/bin/activate"
            pip install -q -r z2m_manager/requirements.txt
            log_success "ĞĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¾ (venv + pip)"
            touch "$MARKER_FILE"
            return 0
        fi
    fi

    # ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğ¹ uv
    if command -v uv &>/dev/null; then
        UV_CMD="uv"
    elif [ -f "$UV_DIR/bin/uv" ]; then
        UV_CMD="$UV_DIR/bin/uv"
    else
        # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ uv
        install_uv
    fi

    # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ venv Ñ‡ĞµÑ€ĞµĞ· uv
    log_info "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ²Ğ¸Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ..."
    rm -rf "$VENV_DIR" 2>/dev/null || true

    $UV_CMD venv "$VENV_DIR" -p "$PYTHON_CMD" -q

    log_info "Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹..."
    $UV_CMD pip install -p "$VENV_DIR/bin/python" -r z2m_manager/requirements.txt -q

    log_success "ĞĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¾"
    touch "$MARKER_FILE"
}

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Docker
check_docker() {
    if ! command -v docker &>/dev/null; then
        log_warning "Docker Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½"
        echo ""
        echo "Ğ”Ğ»Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°Ğ¼Ğ¸ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ Docker:"
        echo "  curl -fsSL https://get.docker.com | sh"
        echo "  sudo usermod -aG docker \$USER"
        echo ""
    fi
}

# Ğ—Ğ°Ğ¿ÑƒÑĞº
run_app() {
    cd "$SCRIPT_DIR"
    source "$VENV_DIR/bin/activate"
    exec python z2m.py "$@"
}

main() {
    cd "$SCRIPT_DIR"

    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ --cli Ğ´Ğ»Ñ Ñ‚Ğ¸Ñ…Ğ¾Ğ³Ğ¾ Ñ€ĞµĞ¶Ğ¸Ğ¼Ğ°
    local quiet=false
    for arg in "$@"; do
        [ "$arg" == "--cli" ] && quiet=true && break
    done

    if [ "$quiet" = false ]; then
        echo ""
        echo -e "${BLUE}ğŸ Z2M Manager${NC}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
    fi

    check_python

    # ĞŸÑ€Ğ¸ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¼ Ğ·Ğ°Ğ¿ÑƒÑĞºĞµ
    if [ ! -f "$MARKER_FILE" ]; then
        check_docker
    fi

    setup_environment
    run_app "$@"
}

main "$@"
