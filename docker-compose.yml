services:
  mqtt:
    build: ./mosquitto/
    ports:
      - 1883:1883
      - 9001:9001
    volumes:
      - mosquitto:/mosquitto/data
      - ./mosquitto/conf.d:/mosquitto/conf.d:ro
      - mosquitto_etc:/mosquitto/etc
    environment:
      - MQTT_USER=${MQTT_USER:-user}
      - MQTT_PASSWORD=${MQTT_PASSWORD}
    restart: unless-stopped
  nodered:
    image: nodered/node-red
    user: "${UID:-1000}:${GID:-1000}"
    profiles:
      - nodered
    ports:
      - 1880:1880
    volumes:
      - nodered:/data
    restart: unless-stopped
  zigbee2mqtt:
    image: koenkk/zigbee2mqtt:1.42.0
    ports:
      - 4000:4000
    devices:
      # Docker не принимает symlink как "device node", поэтому:
      # - ZIGBEE_DEVICE_HOST: реальный /dev/tty* на хосте
      # - ZIGBEE_DEVICE: путь устройства внутри контейнера (по умолчанию /dev/zigbee)
      - "${ZIGBEE_DEVICE_HOST:-/dev/ttyACM0}:${ZIGBEE_DEVICE:-/dev/zigbee}"
    volumes:
      - zigbee2mqtt:/app/data
      - ./zigbee2mqtt.yaml:/app/data/configuration.yaml
    restart: unless-stopped
volumes:
  mosquitto:
  mosquitto_etc:
  nodered:
  zigbee2mqtt:
